{% extends 'base.html' %}
{% from 'macros.html' import back_button %}
{% block title %}{{ _('–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞') }}{% endblock %}
{% block content %}
{# –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∏–∫—Å –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è dropdown —à–∞–ø–∫–∏ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ #}
<style>
  .navbar { position: relative; z-index: 2000; }
  .navbar .dropdown-menu { z-index: 2001; }
  .product-view.container { overflow: visible; }  /* –Ω–µ –æ–±—Ä–µ–∑–∞—Ç—å –≤—ã–ø–∞–¥–∞—à–∫–∏ */
   .product-view .btn-back{
    margin-top: -6px;   /* –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ (–ø–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å) */
    margin-bottom: 16px;/* —á—Ç–æ–±—ã –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª–∞ –∫ –±–ª–æ–∫—É –Ω–∏–∂–µ */
    }
</style>

<div class="container mt-4 product-view">

 {{ back_button(url_for('index')) }}

  <!-- HERO-–ö–ê–†–¢–û–ß–ö–ê: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –ª–æ–∫–∞—Ü–∏—è + —Ñ–æ—Ç–æ/–¥–µ—Ç–∞–ª–∏ -->
  <div class="main-card">
    <h2 class="mb-2">
      <span style="font-size: 1.4em;">ü™®</span> {{ product.name }}
    </h2>

    {% set loc = get_locale() %}
    {% if g.current_warehouse %}
      <div class="text-muted mb-3">
        üìç {{ g.current_warehouse['name_' ~ loc] or g.current_warehouse.code }}
      </div>
    {% endif %}

    {% set can_manage = g.user and g.user.role in ['editor'] %}

    <div class="row">
      <!-- –§–û–¢–û -->
      <div class="col-md-4 mb-4">
        {% if images and images|length > 0 %}
          {% set carousel_id = 'productCarousel_' ~ product.id %}
          <div id="{{ carousel_id }}" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% for img in images %}
                <div class="carousel-item {% if loop.first %}active{% endif %}">
                  <img src="{{ img.url }}" class="d-block w-100 rounded border shadow-sm" alt="{{ product.name }}">
                </div>
              {% endfor %}
            </div>

            {% if images|length > 1 %}
              <button class="carousel-control-prev" type="button"
                      data-bs-target="#{{ carousel_id }}" data-bs-slide="prev"
                      aria-label="{{ _('–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ') }}">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">{{ _('–ù–∞–∑–∞–¥') }}</span>
              </button>
              <button class="carousel-control-next" type="button"
                      data-bs-target="#{{ carousel_id }}" data-bs-slide="next"
                      aria-label="{{ _('–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ') }}">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">{{ _('–í–ø–µ—Ä—ë–¥') }}</span>
              </button>
            {% endif %}
          </div>

          <!-- –°—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ -->
          <div class="text-center mt-2">
            <span id="photoCounter_{{ product.id }}" class="small text-muted">1 / {{ images|length }}</span>
          </div>

          <script>
            document.addEventListener("DOMContentLoaded", function() {
              var counter = document.getElementById("photoCounter_{{ product.id }}");
              var carousel = document.getElementById("{{ carousel_id }}");
              if (carousel && counter) {
                carousel.addEventListener("slid.bs.carousel", function (event) {
                  var total = carousel.querySelectorAll(".carousel-item").length;
                  counter.textContent = (event.to + 1) + " / " + total;
                });
              }
            });
          </script>

        {% elif product.image_url %}
          <img src="{{ product.image_url }}" class="img-fluid rounded border shadow-sm" alt="{{ product.name }}">
        {% endif %}
      </div>

<div class="col-md-8">
  <!-- –û–î–ù–ê —Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: –¥–µ—Ç–∞–ª–∏ + –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
  <div class="glass-card">

    <!-- –î–µ—Ç–∞–ª–∏: –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç—É –∂–µ —Ç–∞–±–ª–∏—Ü—É -->
    <table class="table view-details mb-0">
      <tbody>
        <tr>
          <th>{{ _('–û–ø–∏—Å–∞–Ω–∏–µ') }}</th>
          <td>{{ product.description or '‚Äî' }}</td>
        </tr>
        <tr>
          <th>{{ _('–ö–∞—Ç–µ–≥–æ—Ä–∏—è') }}</th>
          <td>{{ category.name if category else '‚Äî' }}</td>
        </tr>
        <tr>
          <th>{{ _('–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ') }}</th>
          <td>{{ product.wh_quantity|default(0) }} {{ unit_label(product.unit) }}</td>
        </tr>
        <tr>
          <th>{{ _('–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è') }}</th>
          <td>{{ product.created_at_fmt }}</td>
        </tr>
      </tbody>
    </table>

    {% if g.user.role == 'editor' %}
      <hr class="my-3">

      <!-- –°–∫–ª–∞–¥—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ç–æ–π –∂–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
      <h5 class="mb-2">{{ _('–°–∫–ª–∞–¥—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏') }}</h5>

      <!-- –°–ø–∏—Å–∞—Ç—å (–º–∏–Ω—É—Å) -->
      <form class="row g-2 align-items-center"
            action="{{ url_for('consume_stock', product_id=product.id) }}"
            method="post">
        <div class="col-6 col-sm-4">
          <input name="amount" type="number" step="0.01" min="0"
                 class="form-control"
                 placeholder="{{ _('–°–ø–∏—Å–∞—Ç—å,') }} {{ unit_label(product.unit) }}" required>
        </div>
        <div class="col-6 col-sm-5">
          <input name="note" type="text" class="form-control"
                 placeholder="{{ _('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)') }}">
        </div>
        <div class="col-12 col-sm-3">
          <button class="btn btn-danger w-100">
            {{ _('–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞') }}
          </button>
        </div>
      </form>

      <!-- –ü–æ–ø–æ–ª–Ω–∏—Ç—å (–ø–ª—é—Å) -->
      <form class="row g-2 align-items-center mt-2"
            action="{{ url_for('add_stock', product_id=product.id) }}"
            method="post">
        <div class="col-6 col-sm-4">
          <input name="amount" type="number" step="0.01" min="0"
                 class="form-control"
                 placeholder="{{ _('–ü–æ–ø–æ–ª–Ω–∏—Ç—å,') }} {{ unit_label(product.unit) }}" required>
        </div>
        <div class="col-6 col-sm-5">
          <input name="note" type="text" class="form-control"
                 placeholder="{{ _('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)') }}">
        </div>
        <div class="col-12 col-sm-3">
          <button class="btn btn-success w-100">
            {{ _('–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å–∫–ª–∞–¥') }}
          </button>
        </div>
      </form>
    {% endif %}
  </div>

{# ----- MOBILE actions (–≤–Ω–∏–∑—É –∫–∞—Ä—Ç–æ—á–∫–∏) ----- #}
{% if can_manage %}
<div class="mobile-only mt-3 view-actions-mobile">
  <a href="{{ url_for('edit', product_id=product.id) }}"
     class="btn btn-warning w-100 mb-2">
    ‚úèÔ∏è {{ _('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å') }}
  </a>

  <form id="mobileDeleteForm"
        action="{{ url_for('delete', product_id=product.id) }}"
        method="post" class="d-grid">
    <button type="button"
            class="btn btn-danger w-100"
            data-bs-toggle="modal"
            data-bs-target="#confirmModal"
            data-form-id="mobileDeleteForm"
            data-confirm="{{ _('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä ¬´%(name)s¬ª?', name=product.name) }}">
      üóëÔ∏è {{ _('–£–¥–∞–ª–∏—Ç—å') }}
    </button>
  </form>
</div>
{% endif %}

  {% if g.user.role == 'editor' %}
    <!-- –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥ –∫–∞—Ä—Ç–æ—á–∫–æ–π (–∫–∞–∫ –±—ã–ª–æ) -->
    <div class="mt-3 d-none d-md-flex gap-2">
      <a href="{{ url_for('edit', product_id=product.id) }}" class="btn btn-warning">
        ‚úèÔ∏è {{ _('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å') }}
      </a>
<form action="{{ url_for('delete', product_id=product.id) }}"
      method="post"
      data-confirm="{{ _('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä') }} ¬´{{ product.name }}¬ª?"
      data-confirm-ok="{{ _('–£–¥–∞–ª–∏—Ç—å') }}"
      data-confirm-variant="danger">
  <input type="hidden" name="next" value="{{ url_for('index') }}">
  <button type="submit" class="btn btn-danger">üóëÔ∏è {{ _('–£–¥–∞–ª–∏—Ç—å') }}</button>
</form>
    </div>
  {% endif %}
</div>
{% endblock %}
