{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>üì¶ {{ _('–£—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤') }}</h2>
  {% if g.user.role == 'editor' %}
  <div>
    <a href="{{ url_for('create') }}" class="btn btn-success">‚ûï {{ _('–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä') }}</a>
    <a href="#" id="toggleAddCat" class="btn btn-success">üìÅ {{ _('–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é') }}</a>
    <a href="{{ url_for('export_excel') }}" class="btn btn-outline-secondary">{{ _('–°–∫–∞—á–∞—Ç—å Excel') }}</a>
  </div>
  {% endif %}
</div>

<!-- –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ -->
<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="search" value="{{ request.args.get('search', '') }}" class="form-control"
      placeholder="{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ...') }}">
  </div>
  <div class="col-md-2">
    <select name="category_id" class="form-select">
      <option value="">{{ _('–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') }}</option>
      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if request.args.get('category_id', '' )|int==cat.id %}selected{% endif %}>
        {# –í–´–í–û–î –Ω–∞ –Ω—É–∂–Ω–æ–º —è–∑—ã–∫–µ! #}
        {% if current_lang == 'fi' and cat.name_fi %}
        {{ cat.name_fi }}
        {% elif current_lang == 'en' and cat.name_en %}
        {{ cat.name_en }}
        {% else %}
        {{ cat.name }}
        {% endif %}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input type="text" name="size" value="{{ request.args.get('size', '') }}" class="form-control"
      placeholder="{{ _('–†–∞–∑–º–µ—Ä') }}">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="price" value="{{ request.args.get('price', '') }}" class="form-control"
      placeholder="{{ _('–¶–µ–Ω–∞ ‚â§') }}">
  </div>
  <div class="col-md-2">
    <input type="number" step="0.01" name="quantity" value="{{ request.args.get('quantity', '') }}" class="form-control"
      placeholder="{{ _('–ö–æ–ª-–≤–æ ‚â•') }}">
  </div>
  <div class="col-md-1">
    <button type="submit" class="btn btn-outline-primary w-100">{{ _('–ü–æ–∏—Å–∫') }}</button>
  </div>
  <div class="col-md-12 mt-2">
    <a href="{{ url_for('index') }}" class="btn btn-link">{{ _('–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä') }}</a>
  </div>
</form>

<!-- –ò–Ω–ª–∞–π–Ω-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div id="addCatInline" class="inline-panel" aria-hidden="true">
  <div class="row g-2 align-items-center">
    <div class="col-md-6">
      <input type="text" id="newCatName" class="form-control"
             placeholder="{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') }}">
    </div>
    <div class="col-md-3">
      <button id="saveCatBtn" class="btn btn-success w-100">
        {{ _('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å') }}
      </button>
    </div>
    <div class="col-md-3">
      <button id="cancelCatBtn" class="btn btn-outline-secondary w-100" type="button">
        {{ _('–û—Ç–º–µ–Ω–∞') }}
      </button>
    </div>
  </div>
  <div id="catError" class="text-danger mt-2" style="display:none"></div>
</div>

<div class="table-rounded-container">
  <table class="table table-bordered align-middle table-hover mb-0">
    <thead class="table-dark">
      <tr>
        <th>{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ') }}</th>
        <th>{{ _('–ö–∞—Ç–µ–≥–æ—Ä–∏—è') }}</th>
        <th>{{ _('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ') }}</th>
        <th>{{ _('–†–∞–∑–º–µ—Ä') }}</th>
        <th>{{ _('–¶–µ–Ω–∞, ‚Ç¨') }}</th>
        <th>{{ _('–î–µ–π—Å—Ç–≤–∏—è') }}</th>
      </tr>
    </thead>

    <tbody>
      {% for product in products %}
      <tr>
        <td>
          <a href="{{ url_for('view', product_id=product.id) }}" class="text-decoration-none d-flex align-items-center gap-2">
            {% if product.image_url %}
              <img src="{{ product.image_url }}" alt="{{ product.name }}"
                   style="height:36px; width:auto; border-radius:6px; object-fit:cover; margin-right:7px;">
            {% endif %}
            {{ product.name }}
          </a>
        </td>
        <td>
          {% if current_lang == 'fi' and product.category_name_fi %}
            {{ product.category_name_fi }}
          {% elif current_lang == 'en' and product.category_name_en %}
            {{ product.category_name_en }}
          {% else %}
            {{ product.category_name }}
          {% endif %}
        </td>
        <td>{{ product.quantity }} {{ product.unit }}</td>
        <td>{{ product.size }}</td>
        <td>{% if product.price is not none %}{{ '%.2f'|format(product.price) }}{% endif %}</td>
        <td>
          {% if g.user.role == 'editor' %}
            <a href="{{ url_for('edit', product_id=product.id) }}" class="btn btn-warning btn-sm">{{ _('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å') }}</a>
            <form action="{{ url_for('delete', product_id=product.id) }}" method="post" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-sm" data-confirm="{{ _('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?') }}">
                {{ _('–£–¥–∞–ª–∏—Ç—å') }}
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}

      {% if not products %}
      <tr>
        <td colspan="6" class="text-center">{{ _('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ') }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
</div>
<!-- –§–∏—Ä–º–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="main-card mt-4 p-4" style="max-width: 600px; margin-left: auto; margin-right: auto;">
  <h5>üìä {{ _('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:') }}</h5>
  <ul class="list-group mb-4">
    <li class="list-group-item">{{ _('–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:') }} <strong>{{ total_products }}</strong></li>
    <li class="list-group-item">{{ _('–í—Å–µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:') }} <strong>{{ total_categories }}</strong></li>
  </ul>

  <h5>üÜï {{ _('–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:') }}</h5>
  <ul class="list-group">
    {% for product in recent_products %}
    <li class="list-group-item">
      <a href="{{ url_for('view', product_id=product.id) }}" class="text-decoration-none">
        {{ product.name }} ({{ product.quantity }} {{ product.unit }})
      </a>
      ‚Äî {{ product.created_at[:16].replace('T', ' ') }}
    </li>
    {% endfor %}
  </ul>
</div>

<script>
(function () {
  const addBtn    = document.getElementById('toggleAddCat');
  const panel     = document.getElementById('addCatInline');
  const input     = document.getElementById('newCatName');
  const saveBtn   = document.getElementById('saveCatBtn');
  const cancelBtn = document.getElementById('cancelCatBtn');
  const errBox    = document.getElementById('catError');
  const select    = document.querySelector('select[name="category_id"]');

  let closing = false; // —Ñ–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –¥—ë—Ä–≥–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏

  // --- –ø–ª–∞–≤–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ (max-height –∞–Ω–∏–º–∞—Ü–∏—è) ---
  function openPanel() {
    if (closing || panel.classList.contains('show')) return;

    panel.style.display = 'block';
    panel.classList.add('open');       // –¥–µ–ª–∞–µ—Ç –±–ª–æ–∫ –≤–∏–¥–∏–º—ã–º (–Ω–æ –µ—â—ë ¬´—Å–∂–∞—Ç—ã–º¬ª)
    panel.style.maxHeight = '0px';

    requestAnimationFrame(() => {
      // —Ñ–æ—Ä—Å–∏–º —Ä–µ—Ñ–ª–æ—É, –ø–æ—Ç–æ–º —Å—Ç–∞–≤–∏–º —Ü–µ–ª–µ–≤—É—é –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      void panel.offsetHeight;
      panel.style.maxHeight = panel.scrollHeight + 'px';
      panel.classList.add('show');
      panel.setAttribute('aria-hidden', 'false');

      // –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —É–±–µ—Ä—ë–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
      panel.addEventListener('transitionend', () => {
        panel.style.maxHeight = 'none';
      }, { once: true });
    });

    errBox.style.display = 'none';
    errBox.textContent = '';
    setTimeout(() => input && input.focus(), 90);
  }

  // --- –ø–ª–∞–≤–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ (–∏–∑ —Ç–µ–∫—É—â–µ–π –≤—ã—Å–æ—Ç—ã –∫ –Ω—É–ª—é) ---
  function closePanel() {
    if (!panel.classList.contains('open')) return;

    // –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤—ã—Å–æ—Ç—É, –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å –∫ 0
    panel.style.maxHeight = panel.scrollHeight + 'px';
    requestAnimationFrame(() => {
      void panel.offsetHeight;
      panel.style.maxHeight = '0px';
      panel.classList.remove('show');
      panel.setAttribute('aria-hidden', 'true');
    });

    closing = true;

    const finish = () => {
      panel.classList.remove('open');
      panel.style.display = 'none';
      panel.style.maxHeight = ''; // –æ—á–∏—Å—Ç–∫–∞ –∏–Ω–ª–∞–π–Ω-—Å—Ç–∏–ª—è
      closing = false;
    };

    // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –µ—Å–ª–∏ transitionend –≤–Ω–µ–∑–∞–ø–Ω–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    const timer = setTimeout(finish, 650);
    panel.addEventListener('transitionend', () => {
      clearTimeout(timer);
      finish();
    }, { once: true });

    input.value = '';
    errBox.style.display = 'none';
    errBox.textContent = '';
  }

  // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
  addBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    panel.classList.contains('show') ? closePanel() : openPanel();
  });

  // –æ—Ç–º–µ–Ω–∞
  cancelBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    closePanel();
  });

  // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–∫–∞–∫ –±—ã–ª–æ ‚Äî POST + redirect)
  if (saveBtn) {
    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const name = (input.value || '').trim();
      if (!name) {
        errBox.textContent = "{{ _('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.') }}";
        errBox.style.display = 'block';
        input.focus();
        return;
      }
      try {
        saveBtn.disabled = true;
        const resp = await fetch('{{ url_for("add_category") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ name })
        });
        if (resp.redirected) {
          window.location.href = resp.url; // –ø–æ–ª—É—á–∏–º flash –∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
          return;
        }
        window.location.reload();
      } catch (err) {
        errBox.textContent = "{{ _('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.') }}";
        errBox.style.display = 'block';
      } finally {
        saveBtn.disabled = false;
      }
    });
  }
})();
</script>
{% endblock %}