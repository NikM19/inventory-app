{% extends 'base.html' %}
{% from 'macros.html' import back_button %}
{% block content %}
<div class="container product-edit">
  <!-- Назад -->
  <div class="mb-3">
    {{ back_button(url_for('index')) }}
  </div>

  <div class="row g-3">
    <!-- ЛЕВАЯ КОЛОНКА: форма -->
    <div class="col-12 col-lg-6">
      <div class="main-card">
        <h3 class="mb-3">{{ _('Редактировать товар') }}</h3>

        <form method="post" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">{{ _('Название') }}</label>
            <input type="text" name="name" class="form-control" value="{{ product.name }}" required autofocus>
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Категория') }}</label>
            <div class="d-flex align-items-center">
              <select name="category_id" id="categorySelect" class="form-select" style="max-width: 340px;">
                <option value="">{{ _('Без категории') }}</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {% if product.category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
              </select>
              <button type="button"
                      class="btn btn-light btn-sm ms-2 category-edit-btn"
                      id="editCategoryBtn"
                      title="{{ _('Редактировать категорию') }}">
                <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" fill="none" stroke="#7a7a7a" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M15.232 5.232l3.536 3.536M16.732 3.732a2.5 2.5 0 0 1 3.536 3.536L7 21H3v-4l13.732-13.268z"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Количество') }}</label>
            <input type="number" name="quantity" step="0.01" class="form-control" value="{{ product.quantity }}" required>
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Ед. измерения') }}</label>

            {# === 1) Нормализация старых значений === #}
            {% set raw = (product.unit or '')|trim|lower %}
            {% if raw in ['м2','м²','m2'] %}
              {% set cur_code = 'm2' %}
            {% elif raw in ['kg','кг'] %}
              {% set cur_code = 'kg' %}
            {% elif raw in ['pcs','шт','kpl'] %}
              {% set cur_code = 'pcs' %}
            {% else %}
              {% set cur_code = raw %}
            {% endif %}

            {# === 2) Подписи под язык === #}
            {% set loc = get_locale() %}
            {% set m2_label = 'м²' if loc == 'ru' else 'm²' %}
            {% set kg_label  = 'кг' if loc == 'ru' else 'kg' %}
            {% set pcs_label = 'kpl' if loc == 'fi' else ('pcs' if loc == 'en' else 'шт') %}

            {# === 3) Селект — в БД пишем коды m2/kg/pcs === #}
            <select name="unit" class="form-select" required>
              <option value="m2" {{ 'selected' if cur_code == 'm2' else '' }}>{{ m2_label }}</option>
              <option value="kg"  {{ 'selected' if cur_code == 'kg'  else '' }}>{{ kg_label }}</option>
              <option value="pcs" {{ 'selected' if cur_code == 'pcs' else '' }}>{{ pcs_label }}</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Размер') }}</label>
            <input type="text" name="size" value="{{ product.size }}" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Цена, €') }}</label>
            <input type="number" name="price" step="0.01" value="{{ product.price }}" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label">{{ _('Описание') }}</label>
            <textarea name="description" class="form-control">{{ product.description }}</textarea>
          </div>

          <!-- Новые фото -->
          <div class="mb-3">
            <label class="form-label">{{ _('Добавить фото (можно несколько)') }}</label>
            <input type="file" name="images" multiple accept="image/*" class="form-control">
            <div class="form-text">{{ _('Выберите одно или несколько файлов. Они прикрепятся при сохранении.') }}</div>
          </div>

          <div class="mt-3 d-flex gap-2">
            <button type="submit" class="btn btn-success">{{ _('Сохранить') }}</button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">{{ _('Отмена') }}</a>
          </div>
        </form>
      </div>
    </div>

    <!-- ПРАВАЯ КОЛОНКА: галерея -->
    <div class="col-12 col-lg-6">
      {% if images and images|length %}
        <div class="main-card">
          <h5 class="mb-3">{{ _('Фотографии товара') }}</h5>
          <div class="row g-3 edit-gallery">
            {% for img in images %}
              <div class="col-6 col-md-4">
                <div class="card h-100">
                  <img src="{{ img.url }}" class="card-img-top" alt="photo">
                  <div class="card-body p-2 d-flex flex-column gap-2">
                    {% if img.is_primary %}
                      <span class="badge bg-primary align-self-start">{{ _('Главное') }}</span>
                    {% endif %}

                    {% if img.id %}
                      {% if not img.is_primary %}
                        <form method="post" action="{{ url_for('set_primary_image_route', image_id=img.id) }}">
                          <button class="btn btn-sm btn-outline-secondary w-100">{{ _('Сделать главным') }}</button>
                        </form>
                      {% endif %}
                      <form method="post"
                            action="{{ url_for('delete_image_route', image_id=img.id) }}"
                            onsubmit="return confirmDelete();">
                        <button class="btn btn-sm btn-danger w-100">{{ _('Удалить') }}</button>
                      </form>
                    {% else %}
                      <form method="post"
                            action="{{ url_for('clear_legacy_image', product_id=product.id) }}"
                            onsubmit="return confirmDelete();">
                        <button class="btn btn-sm btn-danger w-100">{{ _('Удалить') }}</button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Модалка редактирования категории (оставил твою, только стили кнопок под палитру) -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editCategoryForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editCategoryModalLabel">{{ _('Редактировать категорию') }}</h5>
          <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">{{ _('Отмена') }}</button>
          <button type="submit" class="btn btn-success">{{ _('Сохранить') }}</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCategoryId">
          <div class="mb-3">
            <label for="editCategoryName" class="form-label">{{ _('Новое название категории') }}</label>
            <input type="text" class="form-control" id="editCategoryName" required>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function confirmDelete() {
    return confirm("{{ _('Удалить фото?')|e }}");
  }
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  var editBtn = document.getElementById('editCategoryBtn');
  var modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
  var editCategoryForm = document.getElementById('editCategoryForm');
  var categorySelect = document.getElementById('categorySelect');
  var editCategoryNameInput = document.getElementById('editCategoryName');
  var editCategoryIdInput = document.getElementById('editCategoryId');

  if(editBtn) {
    editBtn.addEventListener('click', function() {
      var selectedOption = categorySelect.options[categorySelect.selectedIndex];
      editCategoryIdInput.value = selectedOption.value;
      editCategoryNameInput.value = selectedOption.text;
      modal.show();
    });
  }

  if(editCategoryForm) {
    editCategoryForm.addEventListener('submit', function(e) {
      e.preventDefault();
      fetch('/edit_category_name', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: editCategoryIdInput.value,
          name: editCategoryNameInput.value
        })
      })
      .then(r => r.json())
      .then(data => {
        if(data.success) {
          var selectedOption = categorySelect.options[categorySelect.selectedIndex];
          selectedOption.text = editCategoryNameInput.value;
          modal.hide();
        } else {
          alert(data.message || 'Ошибка');
        }
      });
    });
  }
});
</script>

{% endblock %}