{% extends 'base.html' %}
{% block title %}{{ _('–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–æ–≤–∞—Ä–∞') }}{% endblock %}
{% block content %}
<div class="container mt-4">

  <!-- –ö–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥ (–¢–û–õ–¨–ö–û –Ω–∞–¥ —Ç–æ–≤–∞—Ä–æ–º) -->
  <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm mb-3">
    ‚Üê {{ _('–ù–∞–∑–∞–¥') }}
  </a>

<h2 class="mb-4">
  <span style="font-size: 1.4em;">ü™®</span> {{ product.name }}
</h2>

{% set loc = get_locale() %}
{% if g.current_warehouse %}
  <div class="text-muted mb-3">
    üìç {{ g.current_warehouse['name_' ~ loc] or g.current_warehouse.code }}
  </div>
{% endif %}

<div class="row">

    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="col-md-4 mb-4">

      {# –ï—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ? –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—É—Å–µ–ª—å #}
{% if images and images|length > 0 %}
  {% set carousel_id = 'productCarousel_' ~ product.id %}
  <div id="{{ carousel_id }}" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
      {% for img in images %}
        <div class="carousel-item {% if loop.first %}active{% endif %}">
          <img src="{{ img.url }}" class="d-block w-100 rounded border shadow-sm" alt="{{ product.name }}">
        </div>
      {% endfor %}
    </div>

    {% if images|length > 1 %}
      <button class="carousel-control-prev" type="button"
              data-bs-target="#{{ carousel_id }}" data-bs-slide="prev"
              aria-label="{{ _('–ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ') }}">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">{{ _('–ù–∞–∑–∞–¥') }}</span>
      </button>
      <button class="carousel-control-next" type="button"
              data-bs-target="#{{ carousel_id }}" data-bs-slide="next"
              aria-label="{{ _('–°–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ') }}">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">{{ _('–í–ø–µ—Ä—ë–¥') }}</span>
      </button>
    {% endif %}
  </div>

<!-- üî¢ –°—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ -->
<div class="text-center mt-2">
  <span id="photoCounter_{{ product.id }}" class="small text-muted">1 / {{ images|length }}</span>
</div>

  <script>
  document.addEventListener("DOMContentLoaded", function() {
    var counter = document.getElementById("photoCounter_{{ product.id }}");
    var carousel = document.getElementById("{{ carousel_id }}");

    if (carousel && counter) {
      carousel.addEventListener("slid.bs.carousel", function (event) {
        var total = carousel.querySelectorAll(".carousel-item").length;
        var index = event.to + 1;
        counter.textContent = index + " / " + total;
      });
    }
  });
  </script>

{% elif product.image_url %}
  <img src="{{ product.image_url }}" class="img-fluid rounded border shadow-sm" alt="{{ product.name }}">
{% endif %}

    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¥–µ—Ç–∞–ª–∏ -->
    <div class="col-md-8">
      <table class="table table-bordered">
        <tbody>
          <tr>
            <th>{{ _('–û–ø–∏—Å–∞–Ω–∏–µ') }}</th>
            <td>{{ product.description or '‚Äî' }}</td>
          </tr>
          <tr>
            <th>{{ _('–ö–∞—Ç–µ–≥–æ—Ä–∏—è') }}</th>
            <td>{{ category.name if category else '‚Äî' }}</td>
          </tr>
         <tr>
  <th>{{ _('–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ') }}</th>
  <td>{{ product.wh_quantity|default(0) }} {{ product.unit }}</td>
</tr>
          <tr>
            <th>{{ _('–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è') }}</th>
            <td>{{ product.created_at_fmt }}</td>
          </tr>
        </tbody>
      </table>

<!-- –°–∫–ª–∞–¥—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
{% if g.user.role == 'editor' %}
<div class="mt-4">
  <h5 class="mb-2">{{ _('–°–∫–ª–∞–¥—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏') }}</h5>

  <!-- –°–ø–∏—Å–∞—Ç—å (–º–∏–Ω—É—Å) -->
  <form class="row g-2 align-items-center"
        action="{{ url_for('consume_stock', product_id=product.id) }}"
        method="post">
    <div class="col-6 col-sm-3">
      <input name="amount" type="number" step="0.01" min="0"
             class="form-control"
             placeholder="{{ _('–°–ø–∏—Å–∞—Ç—å, –º¬≤') }}" required>
    </div>
    <div class="col-6 col-sm-5">
      <input name="note" type="text" class="form-control"
             placeholder="{{ _('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)') }}">
    </div>
    <div class="col-12 col-sm-4">
      <button class="btn btn-danger w-100">
        {{ _('–°–ø–∏—Å–∞—Ç—å —Å–æ —Å–∫–ª–∞–¥–∞') }}
      </button>
    </div>
  </form>

  <!-- –ü–æ–ø–æ–ª–Ω–∏—Ç—å (–ø–ª—é—Å) -->
  <form class="row g-2 align-items-center mt-2"
        action="{{ url_for('add_stock', product_id=product.id) }}"
        method="post">
    <div class="col-6 col-sm-3">
      <input name="amount" type="number" step="0.01" min="0"
             class="form-control"
             placeholder="{{ _('–ü–æ–ø–æ–ª–Ω–∏—Ç—å, –º¬≤') }}" required>
    </div>
    <div class="col-6 col-sm-5">
      <input name="note" type="text" class="form-control"
             placeholder="{{ _('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)') }}">
    </div>
    <div class="col-12 col-sm-4">
      <button class="btn btn-success w-100">
        {{ _('–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å–∫–ª–∞–¥') }}
      </button>
    </div>
  </form>
</div>
{% endif %}

<!-- –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π -->
<div id="movements" class="mt-4">
  {% set loc = get_locale() %}
<h5 class="mb-2">
  {{ _('–ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π') }}
  {% if g.current_warehouse %} ‚Äî {{ g.current_warehouse['name_' ~ loc] or g.current_warehouse.code }}{% endif %}
</h5>

  {% if movements and movements|length > 0 %}
    <div class="table-responsive">
      <table class="table table-sm table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>{{ _('–û–ø–µ—Ä–∞—Ü–∏—è') }}</th>
            <th class="text-end">{{ _('–ö–æ–ª-–≤–æ') }}</th>
            <th>{{ _('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') }}</th>
            <th>{{ _('–ö–µ–º') }}</th>
            <th>{{ _('–ö–æ–≥–¥–∞') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for m in movements %}
          {% set is_plus = (m.delta|float) > 0 %}
          <tr>
            <td>
              {% if is_plus %}
                <span class="badge bg-success">{{ _('–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ') }}</span>
              {% else %}
                <span class="badge bg-danger">{{ _('–°–ø–∏—Å–∞–Ω–∏–µ') }}</span>
              {% endif %}
            </td>
            <td class="text-end {% if is_plus %}text-success{% else %}text-danger{% endif %}">
              {{ '%+.2f'|format(m.delta|float) }} {{ product.unit or '' }}
            </td>
            <td>{{ m.note or '‚Äî' }}</td>
            <td>{{ m.username or '‚Äî' }}</td>
            <td>{{ m.created_at_fmt }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if movements_limit == 20 and movements|length == 20 %}
      <a class="btn btn-link btn-sm mt-2"
         href="{{ url_for('view', product_id=product.id, all=1) }}#movements">
        {{ _('–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë') }}
      </a>
    {% endif %}
  {% else %}
    <div class="text-muted">{{ _('–ó–∞–ø–∏—Å–µ–π –ø–æ–∫–∞ –Ω–µ—Ç.') }}</div>
  {% endif %}
</div>

      {% if g.user.role == 'editor' %}
      <div class="mt-4 d-flex gap-2">
        <a href="{{ url_for('edit', product_id=product.id) }}" class="btn btn-warning">
          ‚úèÔ∏è {{ _('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å') }}
        </a>
<form action="{{ url_for('delete', product_id=product.id) }}" method="POST"
      onsubmit="return confirmDelete()">
  <button type="submit" class="btn btn-danger">üóëÔ∏è {{ _('–£–¥–∞–ª–∏—Ç—å') }}</button>
</form>
      </div>
      {% endif %}
    </div>

  </div>
</div>
<script>
  function confirmDelete() {
    return confirm("{{ _('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')|e }}");
  }
</script>
{% endblock %}