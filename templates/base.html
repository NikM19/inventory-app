<!doctype html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="utf-8">
  <title>{% block title %}{{ _('–°–∫–ª–∞–¥ Artkivi') }}{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" type="image/png"
      href="{{ url_for('static', filename='img/artkivi-logo.png') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ asset_url('artkivi.css') }}">

<script>
  (function () {
    var doc  = document.documentElement;
    var mode = localStorage.getItem('ak_glass_mode') || 'auto';

    function isSafari(){
      var ua = navigator.userAgent;
      return /^((?!chrome|android).)*safari/i.test(ua);
    }

    if (mode === 'on') {
      // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å ¬´—Å—Ç–µ–∫–ª–æ¬ª
      doc.classList.remove('no-glass');
      doc.classList.add('force-glass');
    } else if (mode === 'off') {
      // –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∫–ª—é—á–∏—Ç—å ¬´—Å—Ç–µ–∫–ª–æ¬ª
      doc.classList.add('no-glass');
      doc.classList.remove('force-glass');
    } else {
      // –∞–≤—Ç–æ: –∫–∞–∫ —Ä–∞–Ω—å—à–µ ‚Äî ¬´—Å—Ç–µ–∫–ª–æ¬ª —Ç–æ–ª—å–∫–æ –≤ Safari
      doc.classList.remove('force-glass');
      if (!isSafari()) doc.classList.add('no-glass');
      else             doc.classList.remove('no-glass');
    }
  })();
</script>

</head>
<body>
<nav class="navbar navbar-expand-lg" style="background: #454545;">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
      <img src="{{ url_for('static', filename='img/artkivi-logo.png') }}" alt="Artkivi" height="38" class="me-2">
      <span style="color: #fff; font-weight: 500;">{{ _('–°–∫–ª–∞–¥ Artkivi') }}</span>
    </a>
    <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–æ–µ –º–µ–Ω—é -->
<div class="d-flex align-items-center gap-2 desktop-menu d-none d-lg-flex">
  {% set loc = get_locale() %}

{# üìç –°–∫–ª–∞–¥ (–¥–µ—Å–∫—Ç–æ–ø) ‚Äî –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ /login #}
{% if request.endpoint != 'login' %}
  <div class="dropdown me-2">
    <button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"
            style="color:#fff;"
            aria-label="{{ _('–°–∫–ª–∞–¥') }}"
            title="{{ (g.current_warehouse and (g.current_warehouse['name_' ~ loc] or g.current_warehouse.code)) or '' }}">
      üìç
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      {% for w in g.warehouses %}
        {% set wname = (w['name_' ~ loc] or w.code) %}
        <li>
          <a class="dropdown-item {% if g.current_warehouse and g.current_warehouse.id == w.id %}active{% endif %}"
             href="{{ url_for('set_warehouse', code=w.code) }}">
            {{ wname }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

  <!-- üåê –Ø–∑—ã–∫ -->
  <div class="dropdown me-2">
<button class="btn btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"
        style="color:#fff;"
        aria-label="{{ _('–Ø–∑—ã–∫') }}"
        title="{{ LANGUAGES.get(get_locale()) }}">
  üåê
</button>
    <ul class="dropdown-menu dropdown-menu-end language-dropdown-menu">
      {% for code, lang in LANGUAGES.items() %}
        <li>
          <a class="dropdown-item {% if get_locale() == code %}active{% endif %}"
             href="{{ url_for('set_language', lang=code) }}">{{ lang }}</a>
        </li>
      {% endfor %}
    </ul>
  </div>

      {% if g.user %}
        <span class="navbar-text" style="color: #fff;">
          <span style="font-size:1.3em;vertical-align: middle;">üë§</span>
          {{ g.user.username }}
          {% if g.user.username == 'Constantin.Lennartsson@gmail.com' %}
            <span class="badge bg-dark ms-2" style="font-size: 0.98em;">{{ _('BOSS') }}</span>
          {% elif g.user.username == 'anastasia.hiilas@gmail.com' or g.user.username == 'musatovnikita13@gmail.com' %}
            <span class="badge bg-secondary ms-2" style="font-size: 0.98em;">{{ _('admin') }}</span>
          {% endif %}
        </span>
        {% if g.user.username == 'musatovnikita13@gmail.com' %}
          <a class="btn btn-warning ms-2" href="{{ url_for('logs') }}">{{ _('–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π') }}</a>
        {% endif %}
        {% if g.user and g.user.username == 'musatovnikita13@gmail.com' %}
  <button id="glassToggle" class="btn btn-outline-light ms-2" type="button" title="Toggle glass (auto/on/off)">
    Glass: AUTO
  </button>
{% endif %}
        <a class="btn btn-link ms-2" style="color: #fff;" href="{{ url_for('logout') }}">{{ _('–í—ã–π—Ç–∏') }}</a>
      {% else %}
        {% if request.endpoint not in ['login', 'register'] %}
          <a class="btn btn-outline-light ms-2" href="{{ url_for('login') }}">{{ _('–í—Ö–æ–¥') }}</a>
          {# <a class="btn btn-outline-light ms-2" href="{{ url_for('register') }}">{{ _('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è') }}</a> #}
        {% endif %}
      {% endif %}
    </div>
    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é (–±—É—Ä–≥–µ—Ä) -->
    <div class="mobile-menu align-items-center d-lg-none">
      <button class="navbar-toggler ms-2" id="mobileMenuToggler" type="button" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
        <span class="hamburger" id="hamburgerIcon">
          <span></span><span></span><span></span>
        </span>
      </button>
    </div>
  </div>
</nav>

<!-- Blur overlay –¥–ª—è –≥–∞–º–±—É—Ä–≥–µ—Ä-–º–µ–Ω—é -->
<div class="blur-overlay" id="menuBlurOverlay"></div>

<!-- Slide-down Mobile Menu (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
<div class="mobile-slide-menu" id="mobileSlideMenu">
  <div class="py-1">
    {% set loc = get_locale() %}

{# üìç –°–∫–ª–∞–¥ (–º–æ–±–∞–π–ª) ‚Äî –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ /login #}
{% if request.endpoint != 'login' %}
  <div class="dropdown mb-2">
    <button class="btn btn-sm btn-outline-dark w-100" type="button" data-bs-toggle="dropdown"
            aria-expanded="false" aria-label="{{ _('–°–∫–ª–∞–¥') }}">üìç</button>
    <ul class="dropdown-menu w-100">
      {% for w in g.warehouses %}
        {% set wname = (w['name_' ~ loc] or w.code) %}
        <li>
          <a class="dropdown-item {% if g.current_warehouse and g.current_warehouse.id == w.id %}active{% endif %}"
             href="{{ url_for('set_warehouse', code=w.code) }}">{{ wname }}</a>
        </li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

    <!-- üåê –Ø–∑—ã–∫ -->
    <div class="dropdown mb-2">
      <button class="btn btn-sm btn-outline-dark w-100" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        üåê
      </button>
      <ul class="dropdown-menu w-100">
        {% for code, lang in LANGUAGES.items() %}
          <li>
            <a class="dropdown-item {% if get_locale() == code %}active{% endif %}"
               href="{{ url_for('set_language', lang=code) }}">{{ lang }}</a>
          </li>
        {% endfor %}
      </ul>
    </div>

    {% if g.user %}
      <div class="mb-2">
        <span style="font-size:1.3em;vertical-align: middle;">üë§</span>
        {{ g.user.username }}
        {% if g.user.username == 'Constantin.Lennartsson@gmail.com' %}
          <span class="badge bg-dark ms-2">{{ _('BOSS') }}</span>
        {% elif g.user.username == 'anastasia.hiilas@gmail.com' or g.user.username == 'musatovnikita13@gmail.com' %}
          <span class="badge bg-secondary ms-2">{{ _('admin') }}</span>
        {% endif %}
      </div>
      <div class="menu-actions">
        {% if g.user.username == 'musatovnikita13@gmail.com' %}
          <a class="btn btn-warning w-100" href="{{ url_for('logs') }}">{{ _('–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π') }}</a>
        {% endif %}
        <a class="btn btn-outline-dark w-100" href="{{ url_for('logout') }}">{{ _('–í—ã–π—Ç–∏') }}</a>
      </div>
    {% else %}
      <a class="btn btn-outline-dark w-100 mb-2" href="{{ url_for('login') }}">{{ _('–í—Ö–æ–¥') }}</a>
      {# <a class="btn btn-outline-dark w-100" href="{{ url_for('register') }}">{{ _('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è') }}</a> #}
    {% endif %}
  </div>
</div>

<div class="container-fluid mt-4">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-slide-panel">
        {% for category, message in messages %}
          <div class="flash-slide flash-slide-{{ category }}">
            {{ message }}
            <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.style.display='none';"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  {% block content %}{% endblock %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var toggler = document.getElementById('mobileMenuToggler');
    var menu = document.getElementById('mobileSlideMenu');
    var overlay = document.getElementById('menuBlurOverlay');
    var hamburger = document.getElementById('hamburgerIcon');
    var opened = false;
    function openMenu() {
      opened = true;
      menu.classList.add('open');
      overlay.classList.add('show');
      document.body.style.overflow = 'hidden';
      hamburger && hamburger.classList.add('active');
    }
    function closeMenu() {
      opened = false;
      menu.classList.remove('open');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
      hamburger && hamburger.classList.remove('active');
    }
    toggler && toggler.addEventListener('click', function(e) {
      e.stopPropagation();
      if(opened) closeMenu();
      else openMenu();
    });
    overlay && overlay.addEventListener('click', closeMenu);
    document.addEventListener('click', function(e){
      if(opened && !menu.contains(e.target) && !toggler.contains(e.target)) closeMenu();
    });
    document.addEventListener('keydown', function(e){
      if(opened && (e.key === "Escape" || e.keyCode === 27)) closeMenu();
    });
  });

// –ü–æ–∑–∏—Ü–∏—è —Ñ–ª–µ—à-–ø–∞–Ω–µ–ª–∏ + sticky-offset –¥–ª—è —à–∞–ø–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
function setLayoutVars() {
  var navbar  = document.querySelector('.navbar');
  var panel   = document.querySelector('.flash-slide-panel');
  var filters = document.querySelector('.filters-card');
  var root    = document.documentElement;

  var navHeight = navbar ? navbar.offsetHeight : 64;
  if (panel) panel.style.top = (navHeight + 14) + 'px';
  root.style.setProperty('--ak-sticky-offset', navHeight + 'px');
  root.style.setProperty('--filters-h', (filters ? filters.offsetHeight : 0) + 'px');
}
setLayoutVars();
window.addEventListener('resize', setLayoutVars);

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ BFCache (–∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª)
window.addEventListener('pageshow', function (e) {
  if (e.persisted) { window.location.reload(); }
});

    // ======= FLASH SLIDE AUTOCLOSE =======
    setTimeout(function(){
      document.querySelectorAll('.flash-slide').forEach(function(el){
        el.classList.add('hide');
        setTimeout(function(){
          if(el && el.parentNode) el.parentNode.removeChild(el);
        }, 480);
      });
    }, 5000);
</script>

<script>
  (function(){
    var btn = document.getElementById('glassToggle');
    if (!btn) return;

    function isSafari(){
      var ua = navigator.userAgent;
      return /^((?!chrome|android).)*safari/i.test(ua);
    }

    function apply(mode){
      var doc = document.documentElement;
      localStorage.setItem('ak_glass_mode', mode);

      if (mode === 'on') {
        doc.classList.remove('no-glass');
        doc.classList.add('force-glass');
        btn.textContent = 'Glass: ON';
      } else if (mode === 'off') {
        doc.classList.add('no-glass');
        doc.classList.remove('force-glass');
        btn.textContent = 'Glass: OFF';
      } else {
        // AUTO ‚Äî –∫–∞–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: —Å—Ç–µ–∫–ª–æ —Ç–æ–ª—å–∫–æ –≤ Safari
        doc.classList.remove('force-glass');
        if (!isSafari()) doc.classList.add('no-glass');
        else             doc.classList.remove('no-glass');
        btn.textContent = 'Glass: AUTO';
      }
    }

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
    apply(localStorage.getItem('ak_glass_mode') || 'auto');

    // —Ü–∏–∫–ª –ø–æ —Ä–µ–∂–∏–º–∞–º: AUTO ‚Üí ON ‚Üí OFF ‚Üí ‚Ä¶
    btn.addEventListener('click', function(){
      var cur = localStorage.getItem('ak_glass_mode') || 'auto';
      var next = (cur === 'auto') ? 'on' : (cur === 'on') ? 'off' : 'auto';
      apply(next);
    });
  })();
</script>

<!-- Confirm Modal (–∫–∞—Å—Ç–æ–º–Ω—ã–π) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog" id="confirmModalDialog">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmTitle">{{ _('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('–ó–∞–∫—Ä—ã—Ç—å') }}"></button>
      </div>
      <div class="modal-body">
        <div id="confirmMessage" class="text-muted small"></div>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmCancelBtn" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          {{ _('–û—Ç–º–µ–Ω–∞') }}
        </button>
        <button type="button" id="confirmOkBtn" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  let callback = null;

  const modalEl   = document.getElementById('confirmModal');
  const titleEl   = modalEl.querySelector('.modal-title');
  const messageEl = document.getElementById('confirmMessage');
  const okBtn     = document.getElementById('confirmOkBtn');
  const bsModal   = new bootstrap.Modal(modalEl);

  // –ö–ª–∏–∫ –ø–æ OK
  okBtn.addEventListener('click', function () {
    bsModal.hide();
    if (callback) { const cb = callback; callback = null; cb(); }
  });

  // –£—Ç–∏–ª–∏—Ç–∞: –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç —Ü–≤–µ—Ç–∞ –∫ OK
  function setOkVariant(variant) {
    const v = (variant || 'danger').trim();    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∫—Ä–∞—Å–Ω—ã–π
    okBtn.className = 'btn';                   // —Å–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
    // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º btn-XXX –∏ btn-outline-XXX
    if (v.startsWith('outline-')) {
      okBtn.classList.add('btn', 'btn-' + v);  // –Ω–∞–ø—Ä–∏–º–µ—Ä outline-secondary
    } else {
      okBtn.classList.add('btn', 'btn-' + v);  // –Ω–∞–ø—Ä–∏–º–µ—Ä danger / primary / success
    }
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
  function askConfirm(opts, cb) {
    const { message, title, okText, okVariant } = opts || {};
    if (title && titleEl)  titleEl.textContent = title;
    messageEl.textContent = message || '';
    okBtn.textContent = okText || (okVariant === 'danger' ? '{{ _("–£–¥–∞–ª–∏—Ç—å") }}' : 'OK');
    setOkVariant(okVariant);
    callback = cb;
    bsModal.show();
  }

  // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º submit —É —Ñ–æ—Ä–º —Å data-confirm*
  document.addEventListener('submit', function (e) {
    const form = e.target.closest('form');
    if (!form) return;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –∞—Ç—Ä–∏–±—É—Ç—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ —Ñ–æ—Ä–º–µ
const hasAnyConfirm =
  form.dataset.confirm ||
  form.dataset.confirmTitle ||
  form.dataset.confirmHeader ||
  form.dataset.confirmMessage;

if (!hasAnyConfirm) return; // –Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤ ‚Äî –æ–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞

e.preventDefault();

// –ß–¢–û —á–∏—Ç–∞–µ–º –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Ñ–æ—Ä–º—ã
const titleText = form.dataset.confirmTitle || form.dataset.confirmHeader || '{{ _("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ") }}';
const msg       = form.dataset.confirm || form.dataset.confirmMessage || '';

// –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏
askConfirm({
  message:   msg,
  title:     titleText,
  okText:    form.dataset.confirmOk || 'OK',
  okVariant: form.dataset.confirmVariant || 'danger'
}, () => form.submit());
  }, true);
})();
</script>
</body>
</html>