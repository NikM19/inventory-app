{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>üì¶ {{ _('–£—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤') }}</h2>
  {% if g.user.role == 'editor' %}
  <div>
    <a href="{{ url_for('create') }}" class="btn btn-success">‚ûï {{ _('–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä') }}</a>
    <a href="#" id="toggleAddCat" class="btn btn-success">üìÅ {{ _('–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é') }}</a>
    <a href="{{ url_for('export_excel') }}" class="btn btn-outline-secondary">{{ _('–°–∫–∞—á–∞—Ç—å Excel') }}</a>
  </div>
  {% endif %}
</div>

<!-- –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ -->
<form method="get" class="row g-2 mb-4">
  <div class="col-md-3">
    <input type="text" name="search" value="{{ request.args.get('search', '') }}" class="form-control"
      placeholder="{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ...') }}">
  </div>

  <div class="col-md-2">
    <select name="category_id" class="form-select">
      <option value="">{{ _('–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') }}</option>
      {% for cat in categories %}
      <option value="{{ cat.id }}" {% if request.args.get('category_id', '' )|int==cat.id %}selected{% endif %}>
        {% if current_lang == 'fi' and cat.name_fi %}
          {{ cat.name_fi }}
        {% elif current_lang == 'en' and cat.name_en %}
          {{ cat.name_en }}
        {% else %}
          {{ cat.name }}
        {% endif %}
      </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <input type="text" name="size" value="{{ request.args.get('size', '') }}" class="form-control"
      placeholder="{{ _('–†–∞–∑–º–µ—Ä') }}">
  </div>

  <div class="col-md-2">
    <input type="number" step="0.01" name="price" value="{{ request.args.get('price', '') }}" class="form-control"
      placeholder="{{ _('–¶–µ–Ω–∞ ‚â§') }}">
  </div>

  <div class="col-md-2">
    <input type="number" step="0.01" name="quantity" value="{{ request.args.get('quantity', '') }}" class="form-control"
      placeholder="{{ _('–ö–æ–ª-–≤–æ ‚â•') }}">
  </div>

  <div class="col-md-1">
    <button type="submit" class="btn btn-outline-primary w-100">{{ _('–ü–æ–∏—Å–∫') }}</button>
  </div>

<!-- iOS-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å: –ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ -->
<div class="col-md-2 d-flex align-items-center">
  <div class="switch-row mt-2">
    <label class="ios-switch" aria-label="{{ _('–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ') }}" title="{{ _('–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã —Å –Ω—É–ª–µ–≤—ã–º –æ—Å—Ç–∞—Ç–∫–æ–º') }}">
      <input
        id="zeroOnly"
        type="checkbox"
        name="zero_only"
        value="1"
        {% if request.args.get('zero_only') == '1' %}checked{% endif %}
        onchange="this.form.submit()">
      <span class="ios-slider"></span>
    </label>
    <label class="switch-label" for="zeroOnly">{{ _('–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ') }}</label>
  </div>
</div>

  <div class="col-md-12 mt-2">
    <a href="{{ url_for('index') }}" class="btn btn-link">{{ _('–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä') }}</a>
  </div>
</form>

<div id="addCatInline" class="inline-panel" aria-hidden="true">
  <div class="row g-2 align-items-center">
    <div class="col-12 col-md-6">
      <input type="text" id="newCatName" class="form-control"
             placeholder="{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏') }}">
    </div>
    <div class="col-6 col-md-3">
      <button id="saveCatBtn" class="btn btn-success w-100">
        {{ _('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å') }}
      </button>
    </div>
    <div class="col-6 col-md-3">
      <button id="cancelCatBtn" class="btn btn-outline-secondary w-100" type="button">
        {{ _('–û—Ç–º–µ–Ω–∞') }}
      </button>
    </div>
  </div>
  <div id="catError" class="text-danger mt-2" style="display:none"></div>
</div>

<div class="table-rounded-container">
  <table class="table table-bordered align-middle table-hover mb-0">
    <thead class="table-dark">
      <tr>
        <th>{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ') }}</th>
        <th>{{ _('–ö–∞—Ç–µ–≥–æ—Ä–∏—è') }}</th>
        <th>{{ _('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ') }}</th>
        <th>{{ _('–†–∞–∑–º–µ—Ä') }}</th>
        <th>{{ _('–¶–µ–Ω–∞, ‚Ç¨') }}</th>
        <th>{{ _('–î–µ–π—Å—Ç–≤–∏—è') }}</th>
      </tr>
    </thead>

<tbody>
  {% for product in products %}
  <tr>
    <!-- 1-—è —è—á–µ–π–∫–∞: –Ω–æ–≤—ã–π –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏–¥ -->
<td class="ios-cell" data-label="{{ _('–ù–∞–∑–≤–∞–Ω–∏–µ') }}">
  <!-- –î–µ—Å–∫—Ç–æ–ø: –∫–∞–∫ —Ä–∞–Ω—å—à–µ -->
  <div class="desktop-only d-flex align-items-center gap-2">
    {% if product.image_url %}
      <img src="{{ product.image_url }}" alt="{{ product.name }}"
           style="height:36px;width:auto;border-radius:6px;object-fit:cover;margin-right:7px;">
    {% endif %}
    <a href="{{ url_for('view', product_id=product.id) }}" class="text-decoration-none">
      {{ product.name }}
    </a>
  </div>

<!-- –ú–æ–±–∞–π–ª: –∫–∞—Ä—Ç–æ—á–∫–∞ –ë–ï–ó –º–µ–Ω—é -->
<div
  class="ios-card js-card"
  data-href="{{ url_for('view', product_id=product.id) }}"
  role="link"
  tabindex="0"
  aria-label="{{ _('–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä:') }} {{ product.name }}"
>
  <!-- —à–∞–ø–∫–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ + –∫–∞—Ç–µ–≥–æ—Ä–∏—è -->
  <div class="ios-head">
    <a href="{{ url_for('view', product_id=product.id) }}" class="ios-title">{{ product.name }}</a>
    <span class="ios-cat">
      {% if current_lang == 'fi' and product.category_name_fi %}
        {{ product.category_name_fi }}
      {% elif current_lang == 'en' and product.category_name_en %}
        {{ product.category_name_en }}
      {% else %}
        {{ product.category_name }}
      {% endif %}
    </span>
  </div>

  <!-- —Ç–µ–ª–æ: —Å–ª–µ–≤–∞ —Ñ–æ—Ç–æ, —Å–ø—Ä–∞–≤–∞ –∏–Ω—Ñ–æ -->
  <div class="ios-body">
    <img class="ios-thumb" src="{{ product.primary_image_url or product.image_url }}" alt="{{ product.name }}">
    <div class="ios-info">
      {% if product.size %}
        <div class="ios-line">{{ product.size }}</div>
      {% endif %}
      {% if product.quantity %}
        <div class="ios-line">{{ '%.2f'|format(product.quantity) }}&nbsp;{{ product.unit or '' }}</div>
      {% endif %}
      {% if product.price is not none %}
        <div class="ios-line ios-per">
          {{ '%.2f'|format(product.price) }}&nbsp;‚Ç¨&nbsp;/&nbsp;{{ product.unit or '–º¬≤' }}
        </div>
        <div class="ios-trailing">
          <span class="ios-chip">{{ _('–ò—Ç–æ–≥–æ:') }} {{ '%.2f'|format(product.total_price or 0) }}&nbsp;‚Ç¨</span>
        </div>
      {% endif %}
    </div>
  </div>
</div>
</td>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –º–æ–±–∏–ª–µ -->
    <td class="hide-mobile">{{ product.category_name }}</td>
    <td class="hide-mobile">{{ product.quantity }} {{ unit_label(product.unit) }}</td>
    <td class="hide-mobile">{{ product.size }}</td>
    <td class="hide-mobile price-cell" data-label="{{ _('–¶–µ–Ω–∞, ‚Ç¨') }}">
      {% if product.price is not none %}
        <div class="price-per-unit">
          {{ '%.2f'|format(product.price) }} ‚Ç¨ / {{ product.unit or '–º¬≤' }}
        </div>
        <div class="price-total">
          {{ _('–ò—Ç–æ–≥–æ:') }} {{ '%.2f'|format(product.total_price or 0) }} ‚Ç¨
        </div>
      {% endif %}
    </td>
    <td class="hide-mobile">
      {% if g.user.role == 'editor' %}
        <a href="{{ url_for('edit', product_id=product.id) }}" class="btn btn-warning btn-sm">{{ _('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å') }}</a>
        <form action="{{ url_for('delete', product_id=product.id) }}" method="post" style="display:inline;">
          <button type="submit" class="btn btn-danger btn-sm" data-confirm="{{ _('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?') }}">{{ _('–£–¥–∞–ª–∏—Ç—å') }}</button>
        </form>
      {% endif %}
    </td>
  </tr>
  {% endfor %}

  {% if not products %}
  <tr>
    <td colspan="6" class="text-center">{{ _('–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ') }}</td>
  </tr>
  {% endif %}
</tbody>
  </table>
</div>
<!-- –§–∏—Ä–º–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –Ω–æ–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="main-card mt-4 p-4" style="max-width: 600px; margin-left: auto; margin-right: auto;">
  <h5>üìä {{ _('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:') }}</h5>
  <ul class="list-group mb-4">
    <li class="list-group-item">{{ _('–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:') }} <strong>{{ total_products }}</strong></li>
    <li class="list-group-item">{{ _('–í—Å–µ–≥–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:') }} <strong>{{ total_categories }}</strong></li>
  </ul>

  <h5>üÜï {{ _('–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã:') }}</h5>
  <ul class="list-group">
    {% for product in recent_products %}
    <li class="list-group-item">
      <a href="{{ url_for('view', product_id=product.id) }}" class="text-decoration-none">
        {{ product.name }} ({{ product.quantity }} {{ unit_label(product.unit) }})
      </a>
      ‚Äî {{ product.created_at[:16].replace('T', ' ') }}
    </li>
    {% endfor %}
  </ul>
</div>

<script>
(function () {
  const addBtn    = document.getElementById('toggleAddCat');
  const panel     = document.getElementById('addCatInline');
  const input     = document.getElementById('newCatName');
  const saveBtn   = document.getElementById('saveCatBtn');
  const cancelBtn = document.getElementById('cancelCatBtn');
  const errBox    = document.getElementById('catError');
  const select    = document.querySelector('select[name="category_id"]');

  let closing = false;

  // --- –ø–ª–∞–≤–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ ---
  function openPanel() {
    if (closing || panel.classList.contains('show')) return;

    panel.style.display = 'block';
    panel.classList.add('open');

    requestAnimationFrame(() => {
      panel.classList.add('show');
      panel.setAttribute('aria-hidden', 'false');
    });

    errBox.style.display = 'none';
    errBox.textContent = '';
    setTimeout(() => input && input.focus(), 80);
  }

  // --- –ø–ª–∞–≤–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ ---
  function closePanel() {
    if (!panel.classList.contains('open')) return;

    panel.classList.remove('show');
    panel.setAttribute('aria-hidden', 'true');
    closing = true;

    const finish = () => {
      panel.classList.remove('open');
      panel.style.display = 'none';
      closing = false;
    };

    // –∂–¥—ë–º –∏–º–µ–Ω–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ margin (—Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≤ CSS)
    const onEnd = (e) => {
      if (e.target !== panel) return;
      if (e.propertyName !== 'margin') return;
      panel.removeEventListener('transitionend', onEnd);
      finish();
    };
    panel.addEventListener('transitionend', onEnd);

    // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –µ—Å–ª–∏ transitionend –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    setTimeout(() => {
      if (closing) {
        panel.removeEventListener('transitionend', onEnd);
        finish();
      }
    }, 520);

    // –æ—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    input.value = '';
    errBox.style.display = 'none';
    errBox.textContent = '';
  }

  // –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
  addBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    panel.classList.contains('show') ? closePanel() : openPanel();
  });

  // –æ—Ç–º–µ–Ω–∞
  cancelBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    closePanel();
  });

  // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (POST + redirect –∫–∞–∫ –±—ã–ª–æ)
  if (saveBtn) {
    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const name = (input.value || '').trim();
      if (!name) {
        errBox.textContent = "{{ _('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.') }}";
        errBox.style.display = 'block';
        input.focus();
        return;
      }
      try {
        saveBtn.disabled = true;
        const resp = await fetch('{{ url_for("add_category") }}', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ name })
        });
        if (resp.redirected) {
          window.location.href = resp.url;
          return;
        }
        window.location.reload();
      } catch (err) {
        errBox.textContent = "{{ _('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.') }}";
        errBox.style.display = 'block';
      } finally {
        saveBtn.disabled = false;
      }
    });
  }
})();
</script>

<script>
  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º –∫–ª–∏–∫/Enter –ø–æ –≤—Å–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª–µ)
  (function () {
    const isMobile = () => window.matchMedia('(max-width: 768px)').matches;

    // click/tap
    document.addEventListener('click', function (e) {
      if (!isMobile()) return;
      const card = e.target.closest('.js-card');
      if (!card) return;

      // –ù–µ —É—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤–Ω—É—Ç—Ä–∏
      if (e.target.closest('a, button, input, select, textarea, label, .ios-ellipsis')) return;

      const url = card.dataset.href;
      if (url) window.location.href = url;
    });

    // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (Enter/Space)
    document.addEventListener('keydown', function (e) {
      if (!isMobile()) return;
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const card = e.target.closest('.js-card');
      if (!card) return;
      e.preventDefault();
      const url = card.dataset.href;
      if (url) window.location.href = url;
    });
  })();
</script>
{% endblock %}